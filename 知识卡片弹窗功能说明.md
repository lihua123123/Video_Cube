# 知识卡片弹窗功能说明

## 功能概述

实现了知识卡片在视频播放时以弹窗形式自动出现的功能，提供更好的知识拓展体验。

## 主要特性

### 1. 自动弹出
- ✅ 当视频播放到知识卡片的时间段时，自动显示弹窗
- ✅ 每个卡片在播放过程中只弹出一次，避免重复打扰
- ✅ 智能队列管理：如果有多个卡片同时出现，依次显示

### 2. 自由拖动 ⭐
- ✅ 鼠标拖动头部即可移动弹窗位置
- ✅ 拖动图标提示，直观易用
- ✅ 智能边界检测，防止拖出屏幕
- ✅ 拖动时暂停自动关闭，松开后继续
- ✅ 流畅的拖动动画效果
- ✅ 拖动时增强阴影，提供视觉反馈

### 3. 尺寸调整 ⭐ NEW
- ✅ 右下角显示调整尺寸手柄
- ✅ 鼠标拖动手柄即可调整弹窗大小
- ✅ 支持最小尺寸限制（280x300px）
- ✅ 支持最大尺寸限制（800x900px）
- ✅ 调整时暂停自动关闭，松开后继续
- ✅ 调整时增强边框，提供视觉反馈
- ✅ 智能边界检测，防止超出屏幕
- ✅ **内容动态缩放**：字体和元素大小随窗口调整 🆕
- ✅ 内容自动适应弹窗尺寸变化

### 4. 自动关闭
- ✅ 10秒自动关闭倒计时
- ✅ 底部进度条显示剩余时间
- ✅ 用户可以手动提前关闭

### 5. 交互功能
- ✅ **稍后查看**：关闭当前弹窗，继续观看视频
- ✅ **查看详情**：
  - 在UserPage中：跳转到EditPage编辑器页面
  - 在EditPage中：滚动到对应卡片位置并高亮

### 6. 精美设计
- ✅ 渐变色头部（紫色渐变）
- ✅ 图标和徽章（时间、AI生成、内容类型）
- ✅ 富文本内容展示
- ✅ 平滑动画效果
- ✅ 响应式设计，支持移动端
- ✅ 拖动手柄图标，提示可拖动
- ✅ 调整尺寸手柄图标，提示可调整大小

## 文件结构

### 新增文件
```
Frontend/src/components/
└── KnowledgeCardPopup.vue  # 知识卡片弹窗组件
```

### 修改文件
```
Frontend/src/views/
├── UserPage.vue   # 用户播放页面
└── EditPage.vue   # 编辑器页面
```

## 技术实现

### 组件位置配置
```typescript
position: 'top-right' | 'top-left' | 'bottom-right' | 'bottom-left' | 'center'
```

### 组件尺寸配置
```typescript
size: 'small' (320px) | 'medium' (420px) | 'large' (540px)
```

### 自动关闭配置
```typescript
:auto-close="true"          // 是否启用自动关闭
:auto-close-delay="10"      // 自动关闭延迟（秒）
```

### 拖动配置
```typescript
:draggable="true"           // 是否允许拖动（默认true）
```

## 使用示例

### 在Vue组件中使用

```vue
<template>
  <div>
    <video @timeupdate="handleTimeUpdate"></video>
    
    <!-- 知识卡片弹窗 -->
    <KnowledgeCardPopup
      :card="currentPopupCard"
      :visible="showCardPopup"
      position="top-right"
      size="medium"
      :auto-close="true"
      :auto-close-delay="10"
      :draggable="true"
      @close="handlePopupClose"
      @view-details="handlePopupViewDetails"
    />
  </div>
</template>

<script setup lang="ts">
import KnowledgeCardPopup from '@/components/KnowledgeCardPopup.vue'

const showCardPopup = ref(false)
const currentPopupCard = ref(null)
const displayedCardIds = ref(new Set())

// 检查并显示新卡片
const checkAndShowPopup = (previousCards) => {
  const newCards = currentCards.value.filter(card => {
    const isNew = !previousCards.some(prev => prev.id === card.id)
    const notDisplayed = !displayedCardIds.value.has(card.id)
    return isNew && notDisplayed
  })
  
  if (newCards.length > 0 && !showCardPopup.value) {
    showPopup(newCards[0])
  }
}

// 显示弹窗
const showPopup = (card) => {
  currentPopupCard.value = card
  showCardPopup.value = true
  displayedCardIds.value.add(card.id)
}

// 关闭弹窗
const handlePopupClose = () => {
  showCardPopup.value = false
  currentPopupCard.value = null
}

// 查看详情
const handlePopupViewDetails = (card) => {
  // 处理查看详情逻辑
}
</script>
```

## 核心逻辑

### 1. 卡片显示触发
```typescript
// 视频时间更新时
const updateVideoTime = () => {
  currentVideoTime.value = video.currentTime
  updateCurrentCards()  // 更新当前时间点的卡片列表
}

// 更新当前卡片并检查是否需要弹窗
const updateCurrentCards = () => {
  const previousCards = currentCards.value
  currentCards.value = cards.filter(card => 
    currentTime >= card.startTime && currentTime <= card.endTime
  )
  checkAndShowPopup(previousCards)  // 检查新卡片
}
```

### 2. 防重复显示
```typescript
// 使用Set记录已显示的卡片ID
const displayedCardIds = ref(new Set())

// 只显示未显示过的卡片
const newCards = currentCards.filter(card => 
  !displayedCardIds.has(card.id)
)
```

### 3. 队列管理
```typescript
// 关闭时延迟2秒检查是否有其他卡片
const handlePopupClose = () => {
  showCardPopup.value = false
  setTimeout(() => {
    const unshownCards = currentCards.value.filter(card => 
      !displayedCardIds.value.has(card.id)
    )
    if (unshownCards.length > 0) {
      showPopup(unshownCards[0])
    }
  }, 2000)
}
```

## 样式特性

### 1. 渐变色主题
- 头部：`linear-gradient(135deg, #667eea 0%, #764ba2 100%)`
- 按钮：相同渐变色
- 进度条：相同渐变色

### 2. 动画效果
- 入场动画：`slideIn` (0.3s)
- 过渡动画：`fade` (0.3s)
- 按钮悬停：`transform` + `box-shadow`

### 3. 滚动条美化
```css
.popup-body::-webkit-scrollbar {
  width: 6px;
}
.popup-body::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 3px;
}
```

## 响应式设计

### 桌面端
- 固定宽度：320px / 420px / 540px
- 定位：屏幕边角或中心
- 最大高度：calc(100vh - 40px)

### 移动端（≤768px）
- 宽度：100%
- 上下间距：12px
- 按钮：垂直排列，宽度100%

## 浏览器兼容性

- ✅ Chrome / Edge (最新版)
- ✅ Firefox (最新版)
- ✅ Safari (最新版)
- ✅ 移动端浏览器

## 性能优化

1. **防抖处理**：避免频繁创建/销毁弹窗
2. **延迟渲染**：只在需要时渲染弹窗内容
3. **定时器清理**：组件卸载时清理所有定时器
4. **事件委托**：使用事件委托减少事件监听器

## 拖动功能详解

### 拖动实现原理

1. **拖动区域**: 点击并按住头部区域即可拖动
2. **拖动手柄**: 头部左侧显示拖动图标 `⋮⋮` 作为视觉提示
3. **边界限制**: 自动限制在视口内，防止拖出屏幕
4. **暂停计时**: 拖动时自动暂停关闭倒计时，松开后恢复

### 拖动交互效果

```typescript
// 拖动开始
- 鼠标变为 grabbing 手型
- 弹窗阴影增强
- 暂停自动关闭计时器

// 拖动中
- 实时跟随鼠标位置
- 限制在视口范围内
- 平滑的移动动画

// 拖动结束
- 恢复正常鼠标样式
- 阴影恢复正常
- 继续自动关闭倒计时
```

### CSS 类名说明

```css
.is-draggable     // 可拖动状态，鼠标显示 move
.is-dragging      // 拖动中状态，增强阴影和禁止选择
.is-resizing      // 调整尺寸中状态，增强边框和禁止选择
.draggable-header // 可拖动的头部
.drag-handle      // 拖动手柄图标
.resize-handle    // 调整尺寸手柄
```

## 尺寸调整功能详解

### 调整尺寸实现原理

1. **调整区域**: 点击并拖动右下角的手柄图标
2. **尺寸手柄**: 右下角显示双向箭头图标 `↔↕` 作为视觉提示
3. **尺寸限制**: 
   - 最小宽度: 280px
   - 最小高度: 300px
   - 最大宽度: 800px
   - 最大高度: 900px
4. **边界限制**: 自动限制在视口内，防止超出屏幕
5. **暂停计时**: 调整尺寸时自动暂停关闭倒计时，松开后恢复

### 调整尺寸交互效果

```typescript
// 调整开始
- 鼠标变为 nwse-resize 调整尺寸手型
- 弹窗边框增强（紫色边框）
- 暂停自动关闭计时器
- 手柄图标高亮显示

// 调整中
- 实时更新弹窗宽度和高度
- 限制最小/最大尺寸
- 限制在视口范围内
- 平滑的尺寸变化

// 调整结束
- 恢复正常鼠标样式
- 边框恢复正常
- 手柄图标恢复正常
- 继续自动关闭倒计时
```

### 技术实现细节

```typescript
// 尺寸约束
const MIN_WIDTH = 280
const MAX_WIDTH = 800
const MIN_HEIGHT = 300
const MAX_HEIGHT = 900

// 调整尺寸逻辑
const handleResizeMove = (e: MouseEvent) => {
  if (!isResizing.value) return
  
  const deltaX = e.clientX - resizeStartX.value
  const deltaY = e.clientY - resizeStartY.value
  
  // 计算新尺寸并应用限制
  let newWidth = Math.max(MIN_WIDTH, Math.min(MAX_WIDTH, popupWidth.value + deltaX))
  let newHeight = Math.max(MIN_HEIGHT, Math.min(MAX_HEIGHT, popupHeight.value + deltaY))
  
  // 边界检测
  const maxWidth = window.innerWidth - popupX.value - 20
  const maxHeight = window.innerHeight - popupY.value - 20
  newWidth = Math.min(newWidth, maxWidth)
  newHeight = Math.min(newHeight, maxHeight)
  
  // 更新尺寸
  popupWidth.value = newWidth
  popupHeight.value = newHeight
}
```

## 未来扩展

可以考虑的扩展功能：

1. 🎨 **主题自定义**：支持自定义颜色主题
2. ✅ ~~**位置拖拽**：允许用户拖拽弹窗位置~~ (已实现)
3. ✅ ~~**尺寸调整**：允许用户调整弹窗大小~~ (已实现)
4. 🔊 **声音提示**：卡片出现时播放提示音
5. 📊 **统计追踪**：记录用户交互数据
6. 🎭 **动画选择**：提供多种入场动画效果
7. ⚙️ **用户设置**：允许用户配置弹窗行为
8. 💾 **记忆位置**：记住用户自定义的位置和尺寸

## 测试建议

### 功能测试
- [ ] 视频播放到卡片时间段时是否自动弹出
- [ ] 同一卡片是否只弹出一次
- [ ] 多个卡片是否依次显示
- [ ] 自动关闭倒计时是否正常
- [ ] "稍后查看"按钮是否正常工作
- [ ] "查看详情"按钮是否正常工作
- [ ] 拖动功能是否正常
- [ ] 拖动时是否暂停自动关闭
- [ ] 拖动是否限制在视口内
- [ ] 拖动手柄图标是否显示
- [ ] 调整尺寸功能是否正常
- [ ] 调整尺寸时是否暂停自动关闭
- [ ] 尺寸是否限制在最小/最大值内
- [ ] 调整尺寸是否限制在视口内
- [ ] 调整尺寸手柄是否显示

### 边界测试
- [ ] 视频快进到卡片时间段
- [ ] 视频快退后重新经过卡片时间段
- [ ] 同时有多个卡片的情况
- [ ] 视频暂停时的行为
- [ ] 页面切换时的清理

### 兼容性测试
- [ ] 不同浏览器
- [ ] 不同屏幕尺寸
- [ ] 移动端触摸操作

## 问题排查

### 弹窗不显示
1. 检查 `visible` 属性是否为 `true`
2. 检查 `card` 数据是否有效
3. 检查 z-index 是否被其他元素覆盖
4. 查看控制台是否有错误

### 自动关闭不工作
1. 检查 `auto-close` 是否设置为 `true`
2. 检查 `auto-close-delay` 是否有效
3. 查看是否有定时器清理问题

### 卡片重复显示
1. 检查 `displayedCardIds` Set 是否正常工作
2. 确认卡片 ID 是否唯一
3. 查看 `checkAndShowPopup` 逻辑

### 拖动不流畅
1. 检查是否有性能问题
2. 确认边界检测逻辑是否正确
3. 查看浏览器控制台是否有错误

### 拖动手柄不显示
1. 检查 `draggable` 属性是否设置为 `true`
2. 确认 CSS 样式是否正确加载
3. 查看元素是否被其他元素遮挡

## 总结

这个知识卡片弹窗功能提供了：
- ✅ 非侵入式的知识展示体验
- ✅ 智能的显示时机控制
- ✅ 自由拖动，用户可控位置
- ✅ 优雅的视觉设计
- ✅ 完善的交互逻辑
- ✅ 流畅的动画效果
- ✅ 良好的代码质量和可维护性

通过这个功能，用户可以在观看视频的同时，在适当的时机获得相关知识的补充，并且可以自由调整弹窗位置，不遮挡视频内容，实现真正的知识拓展目的。

## 更新日志

### v1.3.0 (2025-11-23)
- ✨ 新增动态字体缩放功能
- 📏 内容大小随窗口尺寸自动调整
- 🎯 限制缩放比例范围 (0.7 - 1.8)
- 🎨 所有元素等比例缩放，保持视觉和谐
- ⚡ 使用 CSS 变量优化性能

### v1.2.0 (2025-11-23)
- ✨ 新增尺寸调整功能
- ✨ 添加调整尺寸手柄图标
- ✨ 实现最小/最大尺寸限制
- ✨ 调整尺寸时暂停自动关闭
- 🎨 优化调整尺寸视觉效果
- 🎨 内容区域完全自适应伸缩
- 🐛 修复内容溢出问题

### v1.1.0 (2025-11-23)
- ✨ 新增拖动功能
- ✨ 添加拖动手柄图标
- ✨ 实现边界限制
- ✨ 拖动时暂停自动关闭
- 🎨 优化拖动视觉效果
- 🐛 修复TypeScript类型问题

### v1.0.0 (2025-11-23)
- 🎉 初始版本发布
- ✨ 自动弹出功能
- ✨ 自动关闭倒计时
- ✨ 队列管理
- 🎨 精美UI设计
