# 链接详情页拖动缩放功能实现说明

## 📋 功能概述

为 `LinkContentModal` 组件添加了完整的拖动和缩放功能,与 `KnowledgeCardPopup` 保持一致的交互体验。

## ✨ 实现功能

### 1. **拖动功能** 🖱️
- ✅ 点击并拖动模态框标题栏可移动整个窗口
- ✅ 拖动手柄图标显示在标题栏左侧
- ✅ 拖动时显示抓取光标和增强阴影效果
- ✅ 自动限制在视口边界内
- ✅ 鼠标悬停时拖动手柄高亮提示

### 2. **缩放功能** 📐
- ✅ 右下角显示缩放手柄(三角形图标)
- ✅ 拖动手柄可调整窗口宽度和高度
- ✅ 设置了最小尺寸限制(500x400)
- ✅ 设置了最大尺寸限制(1400x900)
- ✅ 缩放时显示特殊光标和蓝色边框高亮
- ✅ 自动限制不超出视口边界

### 3. **初始化行为** 🎯
- ✅ 首次打开时自动居中显示
- ✅ 初始宽度900px,高度根据内容自动调整
- ✅ 响应视口大小,不超出可视区域

## 🔧 技术实现

### 模板结构

```vue
<div 
  ref="modalRef"
  class="link-modal-container" 
  :class="{ 'is-dragging': isDragging, 'is-resizing': isResizing }"
  :style="modalStyle"
>
  <!-- 头部 - 拖动区域 -->
  <div class="link-modal-header" @mousedown="handleDragStart">
    <div class="drag-handle" title="拖动移动窗口">
      <!-- 拖动图标 -->
    </div>
    <div class="link-modal-title">{{ title }}</div>
    <button class="link-modal-close" @click="handleClose">×</button>
  </div>
  
  <!-- 内容区域 -->
  <div class="link-modal-content">
    <!-- ... -->
  </div>
  
  <!-- 缩放手柄 -->
  <div class="resize-handle" @mousedown="handleResizeStart">
    <!-- 缩放图标 -->
  </div>
</div>
```

### 状态管理

```typescript
// 拖动相关状态
const modalRef = ref<HTMLElement | null>(null);
const isDragging = ref(false);
const dragStartX = ref(0);
const dragStartY = ref(0);
const modalX = ref(0);
const modalY = ref(0);
const isPositioned = ref(false);

// 缩放相关状态
const isResizing = ref(false);
const resizeStartX = ref(0);
const resizeStartY = ref(0);
const modalWidth = ref(900);
const modalHeight = ref(0);
const minWidth = ref(500);
const minHeight = ref(400);
const maxWidth = ref(1400);
const maxHeight = ref(900);
```

### 核心函数

#### 1. 初始化位置 `initPosition()`
```typescript
const initPosition = () => {
  if (!modalRef.value || isPositioned.value) return;
  
  const rect = modalRef.value.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  // 初始化尺寸
  modalWidth.value = Math.min(900, viewportWidth * 0.9);
  modalHeight.value = Math.min(rect.height, viewportHeight * 0.8);
  
  // 居中显示
  modalX.value = (viewportWidth - modalWidth.value) / 2;
  modalY.value = (viewportHeight - modalHeight.value) / 2;
  
  isPositioned.value = true;
};
```

#### 2. 拖动处理
```typescript
// 开始拖动
const handleDragStart = (event: MouseEvent) => {
  if (!modalRef.value) return;
  
  const target = event.target as HTMLElement;
  const isHeader = target.closest('.link-modal-header');
  const isCloseBtn = target.closest('.link-modal-close');
  
  if (!isHeader || isCloseBtn) return;
  
  isDragging.value = true;
  dragStartX.value = event.clientX - modalX.value;
  dragStartY.value = event.clientY - modalY.value;
  
  document.addEventListener('mousemove', handleDragMove);
  document.addEventListener('mouseup', handleDragEnd);
  event.preventDefault();
};

// 拖动中
const handleDragMove = (event: MouseEvent) => {
  if (!isDragging.value || !modalRef.value) return;
  
  const rect = modalRef.value.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  let newX = event.clientX - dragStartX.value;
  let newY = event.clientY - dragStartY.value;
  
  // 限制在视口内
  newX = Math.max(0, Math.min(newX, viewportWidth - rect.width));
  newY = Math.max(0, Math.min(newY, viewportHeight - rect.height));
  
  modalX.value = newX;
  modalY.value = newY;
};
```

#### 3. 缩放处理
```typescript
// 开始缩放
const handleResizeStart = (event: MouseEvent) => {
  if (!modalRef.value) return;
  
  isResizing.value = true;
  resizeStartX.value = event.clientX;
  resizeStartY.value = event.clientY;
  
  document.addEventListener('mousemove', handleResizeMove);
  document.addEventListener('mouseup', handleResizeEnd);
  event.preventDefault();
  event.stopPropagation();
};

// 缩放中
const handleResizeMove = (event: MouseEvent) => {
  if (!isResizing.value || !modalRef.value) return;
  
  const deltaX = event.clientX - resizeStartX.value;
  const deltaY = event.clientY - resizeStartY.value;
  
  let newWidth = modalWidth.value + deltaX;
  let newHeight = modalHeight.value + deltaY;
  
  // 限制尺寸范围
  newWidth = Math.max(minWidth.value, Math.min(newWidth, maxWidth.value));
  newHeight = Math.max(minHeight.value, Math.min(newHeight, maxHeight.value));
  
  // 检查视口边界
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  const maxAllowedWidth = viewportWidth - modalX.value - 20;
  const maxAllowedHeight = viewportHeight - modalY.value - 20;
  
  newWidth = Math.min(newWidth, maxAllowedWidth);
  newHeight = Math.min(newHeight, maxAllowedHeight);
  
  modalWidth.value = newWidth;
  modalHeight.value = newHeight;
  resizeStartX.value = event.clientX;
  resizeStartY.value = event.clientY;
};
```

#### 4. 动态样式计算
```typescript
const modalStyle = computed(() => {
  if (!isPositioned.value) {
    return {};
  }
  
  const style: Record<string, string> = {
    position: 'fixed',
    left: `${modalX.value}px`,
    top: `${modalY.value}px`,
    width: `${modalWidth.value}px`,
    height: `${modalHeight.value}px`,
    transform: 'none',
    margin: '0'
  };
  
  return style;
});
```

### CSS 样式

```css
/* 弹窗容器 */
.link-modal-container {
  position: relative; /* 为缩放手柄提供定位基准 */
  background: white;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
}

/* 头部 - 可拖动 */
.link-modal-header {
  cursor: move;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

/* 拖动手柄 */
.drag-handle {
  opacity: 0.6;
  transition: opacity 0.3s;
  cursor: move;
  flex-shrink: 0;
}

.link-modal-header:hover .drag-handle {
  opacity: 1;
}

/* 拖动状态 */
.is-dragging {
  cursor: grabbing !important;
  user-select: none;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
}

.is-dragging * {
  cursor: grabbing !important;
  user-select: none;
}

/* 缩放状态 */
.is-resizing {
  cursor: nwse-resize !important;
  user-select: none;
  border: 2px solid #667eea;
}

.is-resizing * {
  cursor: nwse-resize !important;
  user-select: none;
}

/* 缩放手柄 */
.resize-handle {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 20px;
  height: 20px;
  cursor: nwse-resize;
  z-index: 1000;
  display: flex;
  align-items: flex-end;
  justify-content: flex-end;
  padding: 2px;
  opacity: 0.3;
  transition: opacity 0.3s;
}

.resize-handle:hover {
  opacity: 0.8;
}

.resize-handle svg {
  width: 16px;
  height: 16px;
  color: #666;
}
```

## 📝 关键技术点

### 1. **事件处理优化**
- 使用全局 `mousemove` 和 `mouseup` 监听器
- 拖动/缩放结束时自动清理监听器
- `event.preventDefault()` 防止文本选择
- `event.stopPropagation()` 防止事件冒泡

### 2. **边界检测**
```typescript
// 拖动边界限制
newX = Math.max(0, Math.min(newX, viewportWidth - rect.width));
newY = Math.max(0, Math.min(newY, viewportHeight - rect.height));

// 缩放边界限制
newWidth = Math.min(newWidth, viewportWidth - modalX.value - 20);
newHeight = Math.min(newHeight, viewportHeight - modalY.value - 20);
```

### 3. **尺寸约束**
```typescript
// 最小/最大尺寸限制
newWidth = Math.max(minWidth.value, Math.min(newWidth, maxWidth.value));
newHeight = Math.max(minHeight.value, Math.min(newHeight, maxHeight.value));
```

### 4. **生命周期管理**
```typescript
// 监听可见性变化
watch(() => props.visible, (newVisible) => {
  if (newVisible && modalRef.value) {
    requestAnimationFrame(() => {
      initPosition();
    });
  }
});

// 组件卸载时清理
onUnmounted(() => {
  document.removeEventListener('mousemove', handleDragMove);
  document.removeEventListener('mouseup', handleDragEnd);
  document.removeEventListener('mousemove', handleResizeMove);
  document.removeEventListener('mouseup', handleResizeEnd);
});
```

## 🎨 视觉效果

### 拖动状态
- 光标变为 `grabbing` (抓取状态)
- 阴影增强: `0 12px 40px rgba(0, 0, 0, 0.3)`
- 禁止文本选择: `user-select: none`

### 缩放状态
- 光标变为 `nwse-resize` (东南-西北箭头)
- 蓝色边框高亮: `2px solid #667eea`
- 禁止文本选择: `user-select: none`

### 默认状态
- 拖动手柄透明度: `0.6`
- 缩放手柄透明度: `0.3`
- 悬停时透明度: `1.0` / `0.8`

## 🧪 使用示例

```vue
<template>
  <LinkContentModal 
    :visible="showLinkModal"
    :url="currentUrl"
    :title="currentTitle"
    @close="showLinkModal = false"
    @external-open="handleExternalOpen"
  />
</template>

<script setup lang="ts">
import LinkContentModal from '@/components/LinkContentModal.vue';

const showLinkModal = ref(false);
const currentUrl = ref('');
const currentTitle = ref('');

const openLink = (url: string) => {
  currentUrl.value = url;
  currentTitle.value = '链接详情';
  showLinkModal.value = true;
};
</script>
```

## ✅ 测试检查项

- [ ] 点击标题栏可以拖动窗口
- [ ] 拖动时光标变为抓取状态
- [ ] 拖动时阴影增强
- [ ] 窗口不会拖出视口边界
- [ ] 拖动手柄在悬停时高亮
- [ ] 点击关闭按钮不触发拖动
- [ ] 右下角缩放手柄可见且可拖动
- [ ] 缩放时光标变为调整大小状态
- [ ] 缩放时显示蓝色边框
- [ ] 窗口最小尺寸限制生效(500x400)
- [ ] 窗口最大尺寸限制生效(1400x900)
- [ ] 缩放不会超出视口边界
- [ ] 首次打开时自动居中

## 📊 与 KnowledgeCardPopup 的一致性

| 功能特性 | KnowledgeCardPopup | LinkContentModal | 状态 |
|---------|-------------------|------------------|------|
| 拖动功能 | ✅ | ✅ | 一致 |
| 缩放功能 | ✅ | ✅ | 一致 |
| 拖动手柄图标 | ✅ | ✅ | 一致 |
| 缩放手柄图标 | ✅ | ✅ | 一致 |
| 视口边界约束 | ✅ | ✅ | 一致 |
| 尺寸限制 | ✅ | ✅ | 一致 |
| 拖动光标效果 | ✅ | ✅ | 一致 |
| 缩放光标效果 | ✅ | ✅ | 一致 |
| 悬停高亮效果 | ✅ | ✅ | 一致 |

## 🎯 总结

通过这次实现,`LinkContentModal` 组件现在具备了完整的拖动和缩放功能,用户体验与 `KnowledgeCardPopup` 完全一致。用户可以:

1. **自由拖动**窗口到任意位置
2. **灵活调整**窗口大小以适应不同内容
3. **流畅交互**,所有操作都有即时的视觉反馈
4. **安全约束**,窗口始终保持在可视区域内

这些改进大大提升了链接详情页面的使用灵活性和用户体验! 🎉
