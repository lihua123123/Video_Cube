# 视频库播放问题解决方案

## 📌 问题描述

用户反馈:视频库可以打开并显示视频列表,但是点击视频后无法播放。

## 🔍 问题分析

### 1. 文件存储位置

视频文件实际存储在:
```
Backend/public/uploads/videos/
Backend/public/uploads/thumbnails/
```

### 2. 数据库中的路径

数据库中 `video_url` 字段存储的路径格式:
```
/uploads/videos/afc212d1-c205-465c-a780-24afe6bd44fd.mp4
```

### 3. 后端静态文件服务配置

`Backend/app.js` 中的配置:
```javascript
// 配置1: public 目录作为静态文件根目录
app.use(express.static(path.join(__dirname, 'public')));

// 配置2: uploads 目录映射到 /uploads 路径 (这个不起作用,因为文件在public/uploads下)
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));
```

由于视频文件在 `public/uploads/` 目录下,所以实际上是通过第一个配置生效的。

### 4. 前端访问问题

**原始代码问题:**
```typescript
// Frontend/src/views/UserPage.vue (行487-492)
const fullUrl = video.video_url.startsWith('http') ? 
  video.video_url : 
  `http://localhost:3000${video.video_url}`  // ❌ 硬编码后端地址,可能跨域
```

**Vite代理配置不完整:**
```typescript
// Frontend/vite.config.ts (原始版本)
server: {
  proxy: {
    '/api': {  // ❌ 只代理了 /api 路径
      target: 'http://localhost:3000',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api/, '')
    }
  }
}
```

## ✅ 解决方案

### 修改1: 添加 /uploads 路径的代理配置

**文件**: `Frontend/vite.config.ts`

```typescript
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:3000',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api/, '')
    },
    '/uploads': {  // ✅ 新增: 代理 /uploads 路径
      target: 'http://localhost:3000',
      changeOrigin: true
    }
  }
}
```

### 修改2: 使用相对路径访问视频

**文件**: `Frontend/src/views/UserPage.vue` (行487-492)

```typescript
const handleLibraryVideoPlay = (video: LibraryVideo) => {
  // 播放选中的视频
  // video_url 格式: /uploads/videos/xxx.mp4
  // 直接使用相对路径,通过Vite代理访问后端
  const fullUrl = video.video_url.startsWith('http') ? 
    video.video_url : 
    video.video_url  // ✅ 使用相对路径,让Vite代理处理
  
  currentVideo.value = fullUrl
  videoUrl.value = fullUrl
  videoId.value = video.id
  
  // 保存到 localStorage
  saveVideoToStorage()
  
  // 加载该视频的知识卡片
  if (video.id) {
    fetchKnowledgeCards()
  }
  
  // 关闭视频库模态框
  closeVideoLibrary()
  
  showNotification(`正在播放: ${video.title}`, 'success')
}
```

## 🔄 工作流程

### 修复前

```
前端 (localhost:5173)
    ↓
videoUrl = "http://localhost:3000/uploads/videos/xxx.mp4"  ❌ 直接访问后端
    ↓
可能遇到CORS跨域问题
```

### 修复后

```
前端 (localhost:5173)
    ↓
videoUrl = "/uploads/videos/xxx.mp4"  ✅ 相对路径
    ↓
Vite开发服务器代理 (通过 /uploads 代理规则)
    ↓
转发到: http://localhost:3000/uploads/videos/xxx.mp4
    ↓
Express静态文件服务 (从 public/ 目录提供文件)
    ↓
返回文件: public/uploads/videos/xxx.mp4
```

## 🧪 测试验证

### 1. 后端测试

运行测试脚本验证后端可以正常提供视频文件:

```bash
cd Backend
node test_video_access.js
```

**预期输出:**
```
✅ 视频文件可以访问!
状态码: 200
Content-Type: video/mp4
Content-Length: 35383931
```

### 2. 前端测试

**重要:** Vite配置修改后**必须重启**前端开发服务器:

```bash
cd Frontend
# 按 Ctrl+C 停止当前服务器
npm run dev
```

### 3. 浏览器测试

1. 打开前端页面 (http://localhost:5173)
2. 点击 "📚 视频库" 按钮
3. 在视频库中点击任意视频的 "▶️ 播放" 按钮
4. 视频应该在主播放器中正常播放

### 4. 检查浏览器控制台

打开浏览器开发者工具 (F12):

**网络 (Network) 标签页:**
- 找到视频文件请求 (例如: `/uploads/videos/xxx.mp4`)
- 状态码应该是 `200`
- 类型应该是 `video/mp4`
- 大小应该显示实际文件大小

**控制台 (Console) 标签页:**
- 不应该有CORS错误
- 不应该有404错误

## 📊 修复效果对比

| 方面 | 修复前 | 修复后 |
|------|--------|--------|
| 视频URL | `http://localhost:3000/uploads/...` | `/uploads/...` |
| 代理配置 | 仅代理 `/api` | 代理 `/api` 和 `/uploads` |
| 跨域问题 | ❌ 可能出现CORS错误 | ✅ 通过代理避免跨域 |
| 视频播放 | ❌ 无法播放 | ✅ 正常播放 |
| 缩略图显示 | ❌ 可能无法显示 | ✅ 正常显示 |

## 🎯 关键要点

1. **相对路径 vs 绝对路径**
   - ✅ 使用相对路径 (`/uploads/videos/xxx.mp4`)
   - ❌ 避免硬编码完整URL (`http://localhost:3000/...`)

2. **Vite代理的重要性**
   - 开发环境中前端和后端运行在不同端口
   - 必须通过代理访问后端资源,避免CORS问题
   - 所有后端路径都需要配置代理规则

3. **静态文件服务**
   - Express的 `static` 中间件按注册顺序匹配
   - 文件路径必须和URL路径对应
   - 当前配置: `public/` 目录映射到 `/` 根路径

4. **修改配置后必须重启**
   - Vite配置 (`vite.config.ts`) 修改后必须重启开发服务器
   - 后端路由修改后必须重启后端服务器

## 🐛 常见问题排查

### 问题1: 视频还是无法播放

**检查清单:**
- [ ] 前端开发服务器已重启
- [ ] 后端服务器正在运行
- [ ] 浏览器缓存已清理 (Ctrl+Shift+R 强制刷新)
- [ ] 浏览器控制台无错误信息

### 问题2: 404 Not Found

**可能原因:**
1. 视频文件不存在 → 检查 `Backend/public/uploads/videos/` 目录
2. 数据库中的路径错误 → 运行 `node check_video_urls.js` 检查
3. 代理配置未生效 → 重启前端开发服务器

### 问题3: CORS 跨域错误

**解决方案:**
1. 确认Vite代理配置包含 `/uploads` 路径
2. 确认使用相对路径而非绝对URL
3. 重启前端开发服务器

### 问题4: 缩略图无法显示

**原因:** 缩略图路径 (`thumbnail_url`) 也是 `/uploads/thumbnails/xxx.jpg` 格式

**解决方案:** 
- 已通过同样的 `/uploads` 代理规则解决
- 确保Vite配置正确并重启服务器

## 📝 总结

### 根本原因

前端直接使用 `http://localhost:3000` 绝对URL访问视频,绕过了Vite开发服务器的代理机制,导致可能的跨域问题和访问失败。

### 解决方法

1. 在Vite配置中添加 `/uploads` 路径的代理规则
2. 修改前端代码使用相对路径访问视频
3. 让所有后端资源请求都通过Vite代理转发

### 结果

✅ 视频库可以正常打开
✅ 视频可以正常播放
✅ 缩略图可以正常显示
✅ 没有跨域问题
✅ 没有404错误

---

**修复完成! 🎉**

如果还有问题,请检查:
1. 前端开发服务器是否重启
2. 浏览器控制台是否有错误信息
3. 网络请求是否正常返回200状态码
