<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è§†é¢‘æ’­æ”¾æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f7fa;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #409eff;
        }
        video {
            width: 100%;
            max-width: 800px;
            background: black;
            border-radius: 8px;
        }
        .url-display {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
        }
        .test-btn {
            padding: 10px 20px;
            background: #409eff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .log {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
        }
        .success { color: #67c23a; }
        .error { color: #f56c6c; }
    </style>
</head>
<body>
    <h1>ğŸ¬ è§†é¢‘æ’­æ”¾åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. ç›´æ¥æ’­æ”¾æµ‹è¯•</h2>
        <p>ä½¿ç”¨ç¬¬ä¸€ä¸ªè§†é¢‘çš„ URL è¿›è¡Œæ’­æ”¾æµ‹è¯•</p>
        <button class="test-btn" onclick="testPlayback()">å¼€å§‹æµ‹è¯•</button>
        <div id="url-info"></div>
        <video id="test-video" controls></video>
        <div id="play-log" class="log"></div>
    </div>

    <script>
        let logContent = '';
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            logContent += `<div class="${color}">[${timestamp}] ${message}</div>`;
            document.getElementById('play-log').innerHTML = logContent;
            console.log(message);
        }
        
        async function testPlayback() {
            logContent = '';
            addLog('=== å¼€å§‹è§†é¢‘æ’­æ”¾æµ‹è¯• ===');
            
            try {
                // 1. è·å–è§†é¢‘åˆ—è¡¨
                addLog('ğŸ“¡ æ­£åœ¨è·å–è§†é¢‘åˆ—è¡¨...');
                const response = await fetch('/api/admin/videos?limit=1&offset=0');
                const data = await response.json();
                
                if (!data.status || data.data.videos.length === 0) {
                    addLog('âŒ æ²¡æœ‰æ‰¾åˆ°è§†é¢‘', 'error');
                    return;
                }
                
                const video = data.data.videos[0];
                addLog(`âœ… è·å–åˆ°è§†é¢‘: ${video.title}`, 'success');
                addLog(`åŸå§‹ video_url: ${video.video_url}`);
                
                // 2. æ„å»ºæ’­æ”¾URL
                const playUrl = `/api${video.video_url}`;
                addLog(`æ„å»ºçš„æ’­æ”¾URL: ${playUrl}`);
                
                document.getElementById('url-info').innerHTML = `
                    <div class="url-display">
                        <strong>è§†é¢‘ä¿¡æ¯:</strong><br>
                        æ ‡é¢˜: ${video.title}<br>
                        åŸå§‹URL: ${video.video_url}<br>
                        æ’­æ”¾URL: ${playUrl}
                    </div>
                `;
                
                // 3. æµ‹è¯•URLå¯è®¿é—®æ€§
                addLog('ğŸ” æµ‹è¯•URLå¯è®¿é—®æ€§...');
                try {
                    const headResponse = await fetch(playUrl, { method: 'HEAD' });
                    addLog(`URLå“åº”çŠ¶æ€: ${headResponse.status}`);
                    addLog(`Content-Type: ${headResponse.headers.get('content-type')}`);
                    addLog(`Content-Length: ${headResponse.headers.get('content-length')}`);
                    
                    if (headResponse.status === 200) {
                        addLog('âœ… URLå¯è®¿é—®!', 'success');
                    } else {
                        addLog(`âŒ URLè¿”å›é”™è¯¯çŠ¶æ€ç : ${headResponse.status}`, 'error');
                    }
                } catch (error) {
                    addLog(`âŒ URLè®¿é—®å¤±è´¥: ${error.message}`, 'error');
                }
                
                // 4. è®¾ç½®è§†é¢‘å¹¶æ’­æ”¾
                const videoElement = document.getElementById('test-video');
                
                // ç›‘å¬è§†é¢‘äº‹ä»¶
                videoElement.onloadstart = () => addLog('ğŸ“¥ è§†é¢‘å¼€å§‹åŠ è½½...');
                videoElement.onloadedmetadata = () => {
                    addLog(`âœ… è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ`, 'success');
                    addLog(`è§†é¢‘æ—¶é•¿: ${videoElement.duration}ç§’`);
                    addLog(`è§†é¢‘å®½åº¦: ${videoElement.videoWidth}px`);
                    addLog(`è§†é¢‘é«˜åº¦: ${videoElement.videoHeight}px`);
                };
                videoElement.oncanplay = () => addLog('âœ… è§†é¢‘å¯ä»¥æ’­æ”¾äº†!', 'success');
                videoElement.onplay = () => addLog('â–¶ï¸ è§†é¢‘å¼€å§‹æ’­æ”¾', 'success');
                videoElement.onerror = (e) => {
                    addLog('âŒ è§†é¢‘åŠ è½½é”™è¯¯!', 'error');
                    if (videoElement.error) {
                        const errorMessages = [
                            'æœªçŸ¥é”™è¯¯',
                            'è·å–è§†é¢‘è¢«ä¸­æ­¢ (MEDIA_ERR_ABORTED)',
                            'ç½‘ç»œé”™è¯¯ (MEDIA_ERR_NETWORK)',
                            'è§£ç é”™è¯¯ (MEDIA_ERR_DECODE)',
                            'è§†é¢‘æ ¼å¼ä¸æ”¯æŒ (MEDIA_ERR_SRC_NOT_SUPPORTED)'
                        ];
                        addLog(`é”™è¯¯ä»£ç : ${videoElement.error.code} - ${errorMessages[videoElement.error.code] || errorMessages[0]}`, 'error');
                        addLog(`é”™è¯¯ä¿¡æ¯: ${videoElement.error.message}`, 'error');
                    }
                };
                
                addLog('ğŸ¬ è®¾ç½®è§†é¢‘æºå¹¶å°è¯•æ’­æ”¾...');
                videoElement.src = playUrl;
                videoElement.load();
                
                // å°è¯•è‡ªåŠ¨æ’­æ”¾
                try {
                    await videoElement.play();
                    addLog('âœ… è‡ªåŠ¨æ’­æ”¾æˆåŠŸ!', 'success');
                } catch (error) {
                    addLog(`âš ï¸ è‡ªåŠ¨æ’­æ”¾å¤±è´¥ (å¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢): ${error.message}`);
                    addLog('ğŸ’¡ è¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾æŒ‰é’®');
                }
                
            } catch (error) {
                addLog(`âŒ æµ‹è¯•è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
